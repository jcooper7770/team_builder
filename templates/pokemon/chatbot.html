{% extends "pokemon/base.html" %}

{% block content %}
<br><br>
<div class="container">
  <div class="card border-primary">
    <div class="card-header text-center">
      <h2>Anti-meta chatbot</h2>
    </div>
    <div class="row card-body">
        <div id="convo-div" style="height: 500px; width: 100%; overflow-y: scroll; border: 1px inset #ccc; background-color: light-gray;"></div>
        <!--<textarea disabled id="conversation" style="width: 100%;" rows="20"></textarea>-->
        <div class="col-sm-11">
          <!--<input class="form-control" id="chat" type="text" style="width: 100%;" placeholder="Type here">-->
          <textarea class="form-control" id="chat" type="text" style="width: 100%;" placeholder="Type here"></textarea>
        </div>
        <div class="col-sm-1">
          <button id="send-btn" class="btn btn-success" style="width: 100%">Send</button>
        </div>
        
    </div>
  </div>
</div>

<script type="text/javascript">
/*
var submit = document.getElementById("submit-login");
submit.addEventListener("click", function() {
  var spinnerContainer = document.querySelector(".spinner-container");
  spinnerContainer.style.display = "flex";
});
*/

var send = document.getElementById("send-btn")
send.addEventListener("click", async function () {
  await enterText()
  /*
  var spinnerContainer = document.querySelector(".spinner-container");
  spinnerContainer.style.display = "flex";
  input = document.getElementById("chat");
  if (input.value == "") {
    spinnerContainer.style.display = "none";
    return
  }
  const textVal = input.value
  addConvoRow("{{user}}", textVal, "red");
  input.value = "";

  await getData(textVal);

  spinnerContainer.style.display = "none";
  */
});

async function enterText() {
  var spinnerContainer = document.querySelector(".spinner-container");
  spinnerContainer.style.display = "flex";
  input = document.getElementById("chat");
  if (input.value == "") {
    spinnerContainer.style.display = "none";
    return
  }
  const textVal = input.value
  addConvoRow("{{user}}", textVal, "red");
  input.value = "";

  await getData(textVal);

  spinnerContainer.style.display = "none";

 
}

async function addConvoRow(user, textValue, color) {
  var convo2 = document.getElementById("convo-div");
  var newLine = document.createElement("div");
  var name = document.createElement("span");
  name.style.color = color;
  name.style.fontWeight = "bold";
  name.textContent = user + " > ";
  newLine.appendChild(name);
  var text = document.createElement("span");
  text.textContent = textValue;
  text.style.whiteSpace = "pre-line";
  newLine.appendChild(text);

  convo2.appendChild(newLine);
  convo2.scrollTop = convo2.scrollHeight;
}

async function getData(text) {
  convo = document.getElementById("convo-div").textContent;
  const dataToSend = {
    text: text,
    convo: convo
  };
  try {
    const response = await fetch('/pokemon/chat-gpt', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(dataToSend)
    })
    const data = await response.json();
    console.log(`response: ${data}`);
    addConvoRow("OpenAI", data.result, "blue");
  } catch (error) {
    console.error(`Error: ${error}`);
  }

   /*
  fetch('/pokemon/chat-gpt', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(dataToSend)
  }).then(response => response.json()).then( data => {
    console.log(`response: ${data}`);
    addConvoRow("OpenAI", data.result, "blue");
  }).catch(error => {
    console.error(`Error: ${error}`);
  });*/
}
/*
document.getElementById("chat").addEventListener("keydown", async function (event) {
  if (event.which === 13) {
      if (!event.repeat) {
          const newEvent = new Event("submit", {cancelable: true});
          event.target.form.dispatchEvent(newEvent);
      }

      enterText()
      event.preventDefault(); // Prevents the addition of a new line in the text field
  }
});
*/

function onTestChange() {
  var key = window.event.keyCode;

  // If the user has pressed enter
  if (key === 13 && !window.event.keyCode) {
    //document.getElementById("txtArea").value = document.getElementById("txtArea").value + "\n*";
    enterText()
    return false;
  }
  else {
    return true;
  }
}
</script>
{% endblock %}
{% extends "trampoline/base.html" %}

{% block content %}
<style>
  .profile-pic {
    font-size: 20px;
  }

  p.dark-mode-color {
    color: white;
  }

  .img-container {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .img-post {
    height: 200px;
  }

  .hashtag {
    color: blue;
    font-weight: bold;
  }

  .hashtag:hover {
    text-decoration: underline;
    /* Add any other styling as needed */
    cursor: pointer;
  }

  .search-div {
    display: flex;
    flex-direction: row;
    background: white;
    border-radius: 10px;
    width: fit-content;
    padding: 10px;
  }

  .search-button {
    color: black;
  }

  .search-input {
    border: none;
    background: none;
    margin-left: 5px;
  }
  .post-header {
    display: flex;
    justify-content: space-between;
  }
</style>
<div class="">
  <div class="container mt-5">
    <div class="search-div color-changing ml-auto">
      <a class="search-button" id="search-button" href="#"><i class="fa fa-search" aria-hidden="true"></i></a>
      <input class="search-input color-changing" id="search-input" type="text" placeholder="Search...">
    </div>
    <div class="card color-changing">
      <div class="card-body">
        <p>
          {% with messages = get_flashed_messages() %}
          {% if messages %}
        <ul>
          {% for message in messages %}
          <li>{{ message }}</li>
          {% endfor %}
        </ul>
        {% endif %}
        {% endwith %}
        </p>
        <div class="form-group">
          {% if user %}
          <textarea id="post-text" class="form-control color-changing" rows="3"
            placeholder="Share your routines and turns for today..."></textarea>
          {% else %}
          <textarea id="post-text" class="form-control color-changing" rows="3" placeholder="Login to Post"
            disabled></textarea>
          {% endif %}
        </div>
        <input id="post-file" type="file" name="file" autocomplete="off">
        <button class="btn btn-success color-changing" onclick="addPost()" {% if user=="" %} disabled{% endif
          %}>Post</button>
      </div>
    </div>

    <div id="feed" class="mt-3"></div>
    <br><br>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>

  <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
    crossorigin="anonymous"></script>

  <script>
    var MAX_VID_DURATION = 60;
    var ALLOWED_UPLOAD_EXTS = [
      ".mp4", ".mov", ".jpg", ".png"
    ];
    // Sample array of previous posts
    var previousPosts = [
      {% for post in all_posts %}
    { userName: "{{post.name}}", postText: `{{post.post}}`, date: "{{post.date}}", filename: '{{post.filename | replace("\\", "/")}}' },
    {% endfor %}
      // Add more posts as needed
    ];

    function searchForText(searchText) {
      const feed = document.getElementById("feed");
      const postCards = feed.children;
      for (var i = 0; i < postCards.length; i++) {
        const card = postCards[i];
        const postText = card.children[0].lastElementChild.innerText;
        if (!postText.includes(searchText)) {
          card.style.display = "none";
        } else {
          card.style.display = "";
        }
      }
    }

    const searchBtn = document.getElementById("search-button");
    const searchInput = document.getElementById("search-input");
    searchBtn.addEventListener('click', function (e) {
      e.preventDefault();
      const searchText = searchInput.value;
      //searchInput.value = "";
      searchForText(searchText);
    });

    function checkUploadExt(filename) {
      var allowed = false;
      ALLOWED_UPLOAD_EXTS.forEach((ext) => {
        if (filename.endsWith(ext)) {
          allowed = true;
          return
        }
      });
      return allowed;
    }

    function addPost() {
      var postText = document.getElementById("post-text").value;
      var files = document.getElementById('post-file').files;
      var filename = "";
      var videoDuration = 0;
      if (files.length > 0) {
        filename = `/static/upload/${files[0].name}`;
        console.log(`filename: ${filename}`);
        console.log(`file type: ${files[0].type}`);
        if (!checkUploadExt(filename)) {
          alert("Unsupported filetype uploaded");
          return
        }
        // Set video duration
        if (files[0].type.startsWith("video/")) {
          const vidElement = document.createElement("video");
          vidElement.src = URL.createObjectURL(files[0]);
          vidElement.ondurationchange = function () {
            console.log(`duration: ${vidElement.duration}`);
            videoDuration = vidElement.duration;
          }
        }
      }
      var feedContainer = document.getElementById("feed");

      if (postText.trim() !== "") {
        // wait 300ms for  video duration to set
        setTimeout(function () {
          console.log(`vid dur: ${videoDuration}`);
          if (videoDuration > MAX_VID_DURATION) {
            alert(`Video too long (${videoDuration}s). Must be <60s`);
          } else {
            addPostElements(feedContainer, postText, filename);
          }
        }, 300);
      } else {
        alert("Please enter text for your post");
      }
    }

    function addPostElements(feedContainer, postText, filename) {
      // Get the user's name (replace this with your authentication logic)
      var userName = "{{ user }}"; // Replace with your actual user's name

      var currentDate = new Date();
      const ampm = currentDate.getHours() >= 12 ? "PM" : "AM";
      var formattedDate = currentDate.toLocaleDateString() + " " + currentDate.toLocaleTimeString('en-GB') + " " + ampm;
      addPostWithDetails(feedContainer, userName, formattedDate, postText, filename);

      // Clear the textarea after posting
      document.getElementById("post-text").value = "";
      addPostToDB(userName, formattedDate, postText);
    }

    // Modified addPost function to accept details and insert post at the beginning of the feed
    function addPostWithDetails(container, userName, formattedDate, postText, filename) {
      var postElement = document.createElement("div");
      var fileElement = "";
      if (filename != "") {
        console.log(`filename: ${filename}`);
        var filepath = `{{ url_for('static', filename='uploads/${filename}')}}`;
        filepath = `/uploads/${filename.slice(15)}`;
        if (filepath.endsWith(".mp4") || filepath.endsWith(".mov")) {
          fileElement = `<video class="post-img" id="video" width="100%" controls>
                <source src="${filepath}" type="video/mp4">
                Your browser does not support the video tag.
            </video>`;
        } else {
          fileElement = `<div class="img-container"><img class="img-post" src="${filepath}"></div>`
        }
      }
      postElement.className = "card mt-3";
      const formattedText = formatPost(postText);
      var deleteButton = "";
      if (userName == "{{user}}") {
        deleteButton  = `<button class="btn btn-danger delete-button">Delete</button>`
      }
      postElement.innerHTML = `
        <div class="card-body color-changing post-card">
          <div class="card-subtitle mb-2 post-header">
            <h6 class="text-muted"><a href="/logger/user/${userName}"><i class="fa fa-user-circle-o fa-5x color-changing profile-pic"></i> ${userName}</a> - ${formattedDate}</h6>
            ${deleteButton}
          </div>
          ${fileElement}
          <p class="card-text color-changing">${formattedText.replace(/\n/g, '<br>')}</p>
        </div>
    `;

      // Insert the new post at the beginning of the feed
      container.insertBefore(postElement, container.firstChild);
    }

    // Function to add posts to the feed
    function displayPreviousPosts() {
      var feedContainer = document.getElementById("feed");
      previousPosts.forEach(function (post) {
        addPostWithDetails(feedContainer, post.userName, post.date, post.postText, post.filename);
      });
    }

    // Call the function to display previous posts
    displayPreviousPosts();

    function formatPost(postText) {
      // Use a regular expression to find hashtags in the post text
      const regex = /#(\w+)/g;

      // Replace hashtags with span elements containing the hashtag
      const formattedText = postText.replace(regex, '<span class="hashtag">#$1</span>');

      return formattedText;
    }
    /*
    function formatPost(postText) {
      // Format hashtags to be inside spans
      const regex = /#(\w+)/g;
      const formattedText = postText.replace(regex, '<span class="hashtag">#$1</span' >);
      return formattedText;
    }
    */

    function addPostToDB(name, date, post) {
      const files = document.getElementById('post-file').files;
      var selectedFile;
      if (files.length > 0) {
        selectedFile = files[0];
      } else {
        selectedFile = null;
      }
      console.log(selectedFile);
      const reader = new FileReader();
      var formData = new FormData();
      if (selectedFile) {
        const content = reader.readAsDataURL(selectedFile);
        const xxx = reader.result;
        console.log(xxx);
        formData.append('file', selectedFile)
      }

      formData.append('name', name);
      formData.append('date', date);
      formData.append('post', post);

      /*
      const data = { name: name, date: date, post: post, file: selectedFile }
      $.ajax({
        type: 'POST',
        url: "/logger/social/post",
        contentType: 'application/json',
        //data: JSON.stringify(data),
        data: formData,
        success: function (data) {
          if (data.success) {
            console.log("successfully saved data");
            alert("Success");
          }
        }
      });
      */
      fetch('/logger/social/post', {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          // Handle the response data
          if (data.success) {
            console.log("Successfully saved data");
            alert("Success");
          }
        })
        .catch(error => {
          // Handle errors
          console.error('Error:', error);
        });
     }

     $(document).on('click', '.hashtag', function(e){
      const searchText = e.target.innerText;
      searchInput.value = searchText;
      searchForText(searchText);
     });

     $(document).on('click', '.delete-button', function(e) {
      const name = e.target.previousElementSibling.firstElementChild.innerText;
      console.log(name);
      if (name == " {{ user }}") {
        console.log("!!")
      }
     });

  </script>
</div>
{% endblock %}
{% extends "trampoline/base.html" %}

{% block content %}

<br><br>

<!-- User chart tabs-->
<div class="container">
  <div class="card border-primary">
    <div class="card-header text-center">
      <h2>Practice Graphs</h2>
    </div>
    <div class="card-header">
      <ul class="nav nav-tabs card-header-tabs" id="charts-list" role="tablist">
        {% for event in datapts.keys() %}
        <li class="nav-item">
          <a class="nav-link{% if loop.first %} active{% endif %}" href="#{{event}}" id="{{event}}-tab" data-toggle="tab" aria-controls="{{event}}" role="tab" aria-selected="{% if loop.first %}true{% else %}false{% endif %}">{{ event.replace('_', ' ').capitalize() }}</a>
        </li>
        {% endfor %}
      </ul>
    </div>
    <div class="card-body">

    <div class="tab-content">
      {% for event in datapts.keys() %}
      <div class="tab-pane fade{% if loop.first %}show active{% endif %}" id="{{ event }}" role="tabpanel" aria-labelledby="{{ event }}-tab">
        <canvas class="mx-auto" id="{{event}}Canvas" width="900" height="500"></canvas>
      </div>
      {% endfor %}
    <br>
    <div class="float-right">
    Start: <input id="chart-start" name="chart-start" type="date" placeholder="mm/dd/yyyy" value="{{chart_start}}" \>
    End: <input id="chart-end" name="chart-end" type="date" placeholder="mm/dd/yyyy" value="{{chart_end}}" \>
    <button class="btn btn-primary" id="chart-dates">Update</button>
    <br>
    Show lines: 
    yes: <input type="radio" id="chart-lines-yes" name="chart-lines" value="yes" \>
    no: <input type="radio" id="chart-lines-no" name="chart-lines" value="no" checked \>
    </div>
    </div>
  </div>
</div>
<br/>
<br/>

<!-- Skill stats -->
<div class="container">
  <div class="card border-primary">
    <div class="card-header text-center"><h2>Skill Statistics</h2></div>
    <div class="card-body px-0 py-0">
      <table border=1 class="table table-striped my-0" id="skill_table">
        <thead>
          <tr>
            <th style="position: sticky; top:0; background: gray;" id="col_skill">Skill</th>
            <th style="position: sticky; top:0; background: gray;" id="col_tramp">Trampoline</th>
            <th style="position: sticky; top:0; background: gray;" id="col_dmt">Dmt</th>
            <th style="position: sticky; top:0; background: gray;" id="col_total">Total</th>
          </tr>
        </thead>
        <tbody>
          {% for skill, skill_stats in all_skills.items() %}
          <tr>
            <td>{{skill}}</td>
            <td>{{skill_stats['trampoline']}}</td>
            <td>{{skill_stats['dmt']}}</td>
            <td>{{skill_stats['all']}}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<br>

<div class="container">
  <div class="card border-primary">
    <div class="card-header text-center"><h2>Pass Statistics</h2></div>
    <div class="card-body px-0 py-0">
      <table border=1 class="table table-striped my-0" id="pass_table">
        <thead>
          <tr>
            <th style="position: sticky; top:0; background: gray;" id="col_skill">Pass</th>
            <th style="position: sticky; top:0; background: gray;" id="col_total">Total</th>
          </tr>
        </thead>
        <tbody>
          {% for pass, pass_stats in dmt_passes.items() %}
          <tr>
            <td>{{pass}}</td>
            <td>{{pass_stats['dmt']}}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<br>



<script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
  crossorigin="anonymous"></script>

<script type="text/javascript">
  $("[id^=chart-lines]").click(function (e) {
    var showLines = event.target.id.slice(12);
    if (showLines == "yes"){
      {% for event, data in datapts.items() %}
      myChart{{event}}.data.datasets[0].showLine = true;
      myChart{{event}}.update();
      {% endfor %} 
    } else {
      {% for event, data in datapts.items() %}
      myChart{{event}}.data.datasets[0].showLine = false;
      myChart{{event}}.update();
      {% endfor %} 

    }

  });

  // Adjust chart dates
  $('#chart-dates').click(function(e){
    var start = $('#chart-start').val();
    //const dateRegExp = /^[0-9]{1,2}\/[0-9]{1,2}\/[0-9]{4}$/;
    const dateRegExp = /^[0-9]{4}-[0-9]{1,2}-[0-9]{1,2}$/;
    const startValid = dateRegExp.test(start);
    if (start != "" && startValid == false) {
      alert("Start date has to be in mm/dd/yyyy format");
      return
    }
    var end = $('#chart-end').val();
    const endValid = dateRegExp.test(end);
    if (end != "" && endValid == false) {
      alert("End date has to be in mm/dd/yyyy format");
      return
    }
    // refresh the page to update the charts
    //var url = "/logger/user?chart_start=" + start + "&chart_end=" + end;
    //location.href = encodeURI(url);
  
    // dynamically update the charts
    updateCharts(start, end);
  });
  $("charts-list a").on('click', function(e){
    e.preventDefault();
    $(this).tab('show');
  });
  // Clicking on Canvas point should bring to that day
  $("[id$='Canvas']").click(function (e) {
    var chartId = e.target.id;
    var eventIdx = chartId.slice(0, -6);
    var chart = chartMap.get(eventIdx);
    var activePoint = chart.getElementsAtEvent(e)[0];
    if (activePoint !== undefined) {
      var dataset = chart.data.datasets[activePoint._datasetIndex];
      var date = dataset.data[activePoint._index].x;

      if(confirm("Would you like to go to the practice on " + date + "?")){
        var url = "/logger/search?practice_date=" + date;
        window.open(encodeURI(url));
        //location.href = encodeURI(url);

      }
    }
  });
 
  function updateCharts(start_date, end_date) {
    start = new Date(start_date);
    end = new Date(end_date);

    {% for event, data in datapts.items() %}
    var data_{{event}} = [];
    for (var j=0; j < {{ data | length }}; j++){
      data_date = new Date({{ data | safe }}[j]['x']);
      if ( data_date < start) {
        continue;
      }
      if ( data_date > end ){
        continue;
      }
      data_{{event}}.push({'x': {{ data | safe }}[j]['x'], 'y': {{ data | safe }}[j]['y']});
    }
    myChart{{event}}.data.datasets[0].data = data_{{event}};
    myChart{{event}}.update();
    {% endfor %}

  }

  // One scatter plot per event
  const chartMap = new Map();
  {% for event, data in datapts.items() %}
  const ctx{{event}} = document.getElementById('{{event}}Canvas').getContext('2d');
  const myChart{{event}} = new Chart(ctx{{event}}, {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: '{{ event }}',
          data: [
            {%- for datapt in data -%}
            {x: '{{datapt.x}}', y: {{datapt.y}}}{% if not loop.last %},{% endif %}
            {%- endfor -%}
          ],
          showLine: false,
          fill: false,
          borderColor: {%- if event.startswith("dmt") -%}'rgba(255, 99, 132, 1)'{%- else -%}'rgba(99, 99, 255, 1)'{%- endif -%},
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        xAxes: [{
          type: 'time',
          time: {
            unit: 'day'
          }
        }]
      }
    }
  });
  chartMap.set('{{event}}', myChart{{event}});
  {% endfor %}


// table sorting
function sortTable(f,n,t){
  var s = '#'+ t +' tbody  tr';
  var rows = $(s).get();

  rows.sort(function(a, b) {

    var A = getVal(a);
    var B = getVal(b);

    if(A < B) {
      return -1*f;
    }
    if(A > B) {
      return 1*f;
    }
    return 0;
  });

  function getVal(elm){
    var v = $(elm).children('td').eq(n).text().toUpperCase();
    if($.isNumeric(v)){
      v = parseInt(v,10);
    }
    return v;
  }

  $.each(rows, function(index, row) {
    $('#'+t).children('tbody').append(row);
  });
}
var f_sl = 1;
var f_nm = 1;
// highlight header on hover
$("[id^=col]").mouseover(function(){
  $(this).css({"background-color": "lightgray", "cursor": "pointer"});
});
$("[id^=col]").mouseout(function(){
  $(this).css({"background-color": "gray", "cursor": "pointer"});
});
// sort column on click
$("[id^=col]").click(function(){
    f_sl *= -1;
    table = $(this).closest("table")[0].id;
    console.log(table);
    console.log(f_sl)
    var n = $(this).prevAll().length;
    console.log(n);
    sortTable(f_sl,n, table);
});
</script>
{% endblock %}
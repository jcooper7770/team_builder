{% extends "trampoline/trampoline.html" %}

{% block extra_styles %}
{% endblock %}

{% block additional_bottom_tabs %}
<li class="nav-item">
  <a class="nav-link" data-toggle="tab" href="#lessons-tab">Lesson Plans</a>
</li>
{% endblock %}

{% block logging %}
<div class="spinner-container">
  <div class="spinner"></div>
  <div class="spinner-text">Submitting data...</div>
  <button id="spinner-close" class="spinner-close" aria-label="Close">
    <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
      <path
        d="M10.894 9l6.553-6.553a1 1 0 1 0-1.414-1.414L9.48 7.586 2.928 1.034a1 1 0 0 0-1.414 1.414L7.066 9 .514 15.553a1 1 0 0 0 1.414 1.414L9 10.414l6.553 6.553a1 1 0 0 0 1.414-1.414L10.894 9z"
        fill-rule="evenodd"></path>
    </svg>
  </button>
</div>

<br>
<div class="container form-group tab-pane fade show active" align="center" id="form"
  style="background: rgba(255,255,255,0.4); border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">

  <div class="form-row">
    <!-- Athletes to show -->
    <div class="col-sm-4"><label>Athletes shown:</label></div>
    <div class="col">
      <ul id="shown_athletes" class="athlete-list mx-auto text-left">
        {% for athlete, athlete_data in users.items() %}
        {% if not athlete_data.is_coach and athlete in athletes %}
        <li id="athlete_{{athlete}}">
          <input type="checkbox" id="show_{{athlete}}" \> {{athlete}} ({{athlete_data.details.first_name}}
          {{athlete_data.details.last_name}})
        </li>
        {% endif %}
        {% endfor %}
      </ul>
    </div>
  </div>
  <div class="form-row">

    <!-- Athletes to hide -->
    <div class="col-sm-4"><label>Athletes hidden:</label></div>
    <div class="col">
      <ul id="hidden_athletes" class="athlete-list mx-auto text-left"></ul>
    </div>

  </div>

  <!--</form>-->

</div>
{% endblock %}

{% block additional_tabs %}
<div id="lessons-tab" class="tab-pane fade">
  <div class="container page-desc">
    <h4>Add lesson plans</h4>
    <p>Create lesson plans that your athletes can view</p>
  </div>
  <div class="container">
    <form id="lessonForm">
      <div class="form-group">
        <label for="title">Lesson Title:</label>
        <input type="text" class="form-control color-changing" id="title" name="title" placeholder="Give the lesson plan a title" required>
      </div>

      <div class="form-group">
        <label for="description">Lesson Description:</label>
        <textarea class="form-control color-changing" id="description" name="description" rows="4" placeholder="Type the lesson plan here..." required></textarea>
      </div>

      <div class="form-group">
        <label for="date">Lesson Date:</label>
        <input type="date" class="form-control color-changing" id="date" name="date" required>
      </div>

      <button type="button" class="btn btn-primary color-changing" onclick="addLessonPlan()">Add Lesson Plan</button>
    </form>

    <div id="lessonPlans" class="mt-4">
      <!-- Display added lesson plans here -->
    </div>
  </div>
</div>
{% endblock %}

<br>

<br><br><br>

{% block javascript %}
<script type="text/javascript">
  // Update tables on the fly
  $("[id^=show_]").click(function (e) {
    if (e.target.parentElement.parentElement.id == "shown_athletes") {
      document.getElementById("hidden_athletes").appendChild(e.target.parentElement);
    } else {
      document.getElementById("shown_athletes").appendChild(e.target.parentElement);
    }
    e.target.checked = false;
    changeView();

    // sort the items by athlete name
    sortAthletes("shown_athletes");
    sortAthletes("hidden_athletes");
  });

  function sortAthletes(listId) {
    var athletes = [];
    const athleteList = document.getElementById(listId);
    var athletes = Array.from(athleteList.children);
    athletes.sort((a, b) => (a.innerText > b.innerText) ? 1 : -1);
    for (athlete of athletes) {
      athleteList.appendChild(athlete);
    }
  }

  function changeView() {
    var selected = [];
    const usernameRegex = /^(\w+)\s+\(.*\)$/;


    const athletesSelect = document.getElementById("after");
    const shownList = document.getElementById("shown_athletes");
    for (listItem of shownList.children) {
      const athleteName = listItem.innerText.trim();
      if (athleteName != "") {
        var athleteUsername = "";
        console.log(`name: ${athleteName}`);
        // Use the regex to extract the username
        const match = athleteName.match(usernameRegex);
        if (match && match.length > 1) {
          athleteUsername = match[1];
          console.log(`username: ${athleteUsername}`);
          selected.push(athleteUsername);
        }
      }
    }

    for (let i = 0; i < paginated_practices.length; i++) {
      var page = paginated_practices[i];
      for (let j = 0; j < page.length; j++) {
        var container = page[j];
        var table = container.children[0];

        // re-display the table incase it was hidden
        table.style.display = "";
        if (selected.length == 0) {
          continue
        }
        var thead = table.children[0];
        var title = thead.children[0].children[0].children[0].innerHTML;
        var includes = false;
        for (ath of selected) {
          if (title.includes(ath)) {
            includes = true;
          }
        }
        if (!includes) {
          table.style.display = "none";
        }
      }
    }
    repaginate();
  }
  function addLessonPlan() {
    // Get form values
    const title = document.getElementById('title').value;
    const description = document.getElementById('description').value;
    const date = document.getElementById('date').value;

    if (title == "" || description == "" | date == "") {
      alert("Please finish filling out form");
      return
    }

    // Create a new lesson plan object
    const lessonPlan = {
      title: title,
      description: description,
      date: date
    };

    // Display the lesson plan using Bootstrap alert
    const lessonPlansDiv = document.getElementById('lessonPlans');
    const newLessonPlanDiv = document.createElement('div');
    newLessonPlanDiv.classList.add('alert', 'alert-success');
    newLessonPlanDiv.innerHTML = `<div class="lesson-plan">
                                    <div class="lesson-plan-header">
                                      <strong>${title}</strong>
                                      <button class="btn btn-warning btn-sm" onclick="editLessonPlan(this)"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></button>
                                      </div>
                                    <p>Date: ${date}</p>
                                    <p>${description}</p>
                                  </div>
                                    <hr>`;
    lessonPlansDiv.appendChild(newLessonPlanDiv);

    // You can also send the lesson plan object to your server or store it in a database
    // For simplicity, we are just displaying it here

    // Clear the form after adding the lesson plan
    document.getElementById('lessonForm').reset();
  }

  function editLessonPlan(button) {
    // Get the parent container of the lesson plan
    var lessonPlanContainer = button.parentNode.parentNode;
    if (button.tagName == "I") {
      lessonPlanContainer = lessonPlanContainer.parentNode;
    }

    // Extract the current details
    const title = lessonPlanContainer.children[0].children[0].textContent;
    const description = lessonPlanContainer.children[2].textContent;
    const date = lessonPlanContainer.children[1].textContent.replace('Date: ', '');

    // Populate the form with the current details
    document.getElementById('title').value = title;
    document.getElementById('description').value = description;
    document.getElementById('date').value = date;

    // Remove the edited lesson plan from the display
    lessonPlanContainer.parentNode.remove();
  }
</script>
{% endblock %}